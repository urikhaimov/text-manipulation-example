<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />

    <title>Text manipulation exercise</title>
    <script>

        const replaceSelectedText = (replacementText) => {
            var sel, range;
            if (window.getSelection) {
                sel = window.getSelection();
                if (sel.rangeCount) {
                    range = sel.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(document.createTextNode(replacementText));
                }
            } else if (document.selection && document.selection.createRange) {
                range = document.selection.createRange();
                range.text = replacementText;
            }
        }

        const getSelectedText = () => {
            if (window.getSelection) {
                return window.getSelection();
            } else if (document.selection) {
                return document.selection.createRange();
            }
            return null;
        }

        const transformSelectedToBold = () => {
            const selected = getSelectedText()
            let span = document.createElement('SPAN');
            span.classList.add('bold');
            span.textContent = selected.toString();
            var range = selected.getRangeAt(0);
            range.deleteContents();
            range.insertNode(span);
        }

        const convertSelectedToArray = (text, selectedText, start, end) => {
            let selectedArr = [...selectedText.split(' ')]
            if (text[start] === undefined) {
                selectedArr.push(' ')
            }
            console.log('end', end, text[end])
            if (text[end - 1] === undefined) {
                selectedArr.unshift(' ')

            }
            //              console.log('start',start, text[start], text[start-1])
            if (text[start] !== ' ' && text[start - 1] !== ' ' && start > 0) {

                //              console.log('start', selectedArr)
                const first = selectedArr[0]

                selectedArr.shift()

                if (!selectedArr[selectedArr.length - 1]) {
                    selectedArr.pop()
                    selectedArr.unshift(' ')
                }

                selectedArr.push(first)
                //            console.log('start after', selectedArr)
            }
            console.log('end', end, text[end - 1], text[end])
            if (text[end] !== ' ' && text[end - 1] !== ' ' && end < text.length) {
                console.log('end', selectedArr)
                const last = selectedArr[selectedArr.length - 1]

                selectedArr.pop()
                console.log('pop', !selectedArr[0])
              
                if (!selectedArr[0]) {
                    selectedArr.push(' ')
                    console.log('in', selectedArr)
                }
                selectedArr.unshift(last)
                console.log('end after', selectedArr)
            }


            return selectedArr.reverse()
        }

        const reverseSelected = (text) => {
            const selection = getSelectedText();
            let selectedText = selection.toString();
            const start = selection.anchorOffset;
            const end = selection.focusOffset;

            console.log(start, end)
            const r = convertSelectedToArray(text, selectedText, start, end)
            console.log('r', r)
            replaceSelectedText([...r].join(' '));
        }

        window.onload = () => {
            const text = document.getElementById('text');
            const bold = document.getElementById('bold')
            const reverse = document.getElementById('reverse')

            text.addEventListener('mouseup', e => {

                const selection = getSelectedText();
                const tooltip = document.getElementById('tooltip')
                tooltip.style.visibility = 'visible';
                selection.toString() !== '' &&
                    console.log('"' + selection + '" was selected at ' + e.pageX + '/' + e.pageY);



            });
            bold.addEventListener('click', transformSelectedToBold, false)
            reverse.addEventListener('click', reverseSelected.bind(this, text.innerText), false)

        }



    </script>
    <style>
        /* Tooltip container */
        #tooltip {
            visibility: hidden;
            width: 120px;
            padding: 5px 0;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
        }

        .bold {
            font-weight: bold;
        }

        /* Show the tooltip text when you mouse over the tooltip container */
        /* .tooltip:hover .tooltiptext {
  visibility: visible;
} */
    </style>
</head>

<body>
    <div id="root">

        <div contenteditable="true" id="text">fooobar fo foo foo fooooo


        </div>
        <div id="tooltip">
            <button id="bold">B</button>
            <button id="reverse">R</button>
        </div><br><br>

    </div>

</body>

</html>